{% extends "base.html" %}

{% block title %} {{ datastory_data.title }} {% endblock %}

<!-- Specific Page CSS goes HERE  -->
{% block stylesheets %}
<link rel="stylesheet" href="/melody/static/css/templates.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.8.0/dist/leaflet.css"
  integrity="sha512-hoalWLoI8r4UszCkZ5kL8vayOGVae1oxXe/2A4AO6J9+580uKHDO3JdHb7NzwwzK5xr/Fs0W40kiNHxM9vyTtQ=="
  crossorigin="" />
<link rel="stylesheet" href="/melody/static/css/MarkerCluster.css">
<link rel="stylesheet" href="/melody/static/css/MarkerCluster.Default.css">
<link rel="stylesheet" href="/melody/static/css/leaflet-sidebar.css">

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"
  integrity="sha512-GsLlZN/3F2ErC5ifS5QtgpiJtWd43JWSuIgh7mbzZ8zBps+dvLusV+eNQATqgA/HdeKFVgA5v3S/cIrLF7QnIg=="
  crossorigin="anonymous" referrerpolicy="no-referrer"></script>
{% endblock stylesheets %}

{% block content %}


{% set count = datastory_data.dynamic_elements|length %}

<div class="content row datastorypage" id="dwn">
  <section id="secondarymenu" class="secondarymenu col-md-3 col-sm-12">
    <section id="secondarymenuinner" class="secondarymenuinner">

      <h4>About this story</h4>
      {% if datastory_data.curator %}
      <p>Authors: {{ datastory_data.curator }} </p>
      {%endif%}
      <p>Part of: {{ datastory_data.section_name }}</p>
      <p>Source: <a href="{{datastory_data.sparql_endpoint}}">SPARQL endpoint</a></p>
      <p>Export</p>
      <button class="exportbutton" onclick="getPDF('dwn')" type="button" name="button">PDF</button>
      <button class="exportbutton" type="button"><a onclick="getHTML(this)" href="#"
          download="{{datastory_data.title}}.html">HTML</a></button>
      <button class="exportbutton" type="button"><a href="#" data-toggle="modal" data-target="#queryModal"
          id="sparqlQuery">QUERIES</a></button>
      <!-- publish button -->
      {% if datastory_data.id and session['user_type'] == 'extra' %}
      <hr>
      <form method="post">
        <button type="submit" method="post" class="btn btn-success prevent_alert publish_btn">Publish
          now!</button>
      </form>
      {% endif %}
      <!-- modify button -->
      {% if datastory_data.id and session['user_type'] == 'extra' or session['user_type'] == 'random' %}
      <a class="btn btn-success publish_btn prevent_alert" id="prevent_alert"
        href="{{ url_for('modify_datastory', section_name=datastory_data.id, datastory_name=datastory_data.title|replace(' ', '_')|lower ) }}">
        Modify
      </a>
      {% endif %}
    </section>
  </section>
  <div class="panel-header bg-primary-gradient col-md-9 col-sm-12 datastorypagefields">
    <div class="page-inner py-5">
      <div class="d-flex align-items-left align-items-md-center flex-column flex-md-row">
        <div id="maps_datastory_final">
          <h1 class="text-white pb-2 fw-bold">{{ datastory_data.title }}</h1>
          {% if datastory_data.subtitle %}
          <h2 class="text-white op-7 mb-2">
            {{ datastory_data.subtitle }}
          </h2>
          {%endif%}
          {% if datastory_data.description %}
          <p class="card-category">
            {{ datastory_data.description }}
          </p>
          {%endif%}
          <span id='loader' class='lds-dual-ring hidden overlay'></span>
          <!-- textsearch results -->
          {% for dict in datastory_data.dynamic_elements %}
          {% if dict.type == 'map_filter' %}
          <input class='inputinvisible' id='{{dict.position}}__map_filter_title' type='hidden'
            name='{{dict.position}}__map_filter_title' placeholder='The title of the filter'
            value="{{dict.map_filter_title}}">
          <textarea class='inputinvisible' oninput='auto_grow(this)' name='{{dict.position}}__map_filter_query'
            type='hidden' id='{{dict.position}}__map_filter_query' rows='6'
            data-bind-query='{{dict.map_filter_bind_query}}' required>{{dict.map_filter_query}}</textarea>
          {% endif %}
          {% if dict.type == 'map' %}
          {% if dict.map_title | length > 0 %}
          <h2 class="text-white pb-2 fw-bold">{{dict.map_title}}</h2>
          {% endif %}
          <input class='addplaceholder_points' name='{{dict.position}}__map_points_query' type='hidden'
            id='{{dict.position}}__map_points_query' value='{{dict.map_points_query}}'></input>
          <div class="map_preview_container" id="{{dict.position}}__map_preview_container">
          </div>
          {% endif %}


          {% endfor %}

          <!-- SPARQL query modal -->
          <div class="modal fade" id="queryModal" tabindex="-1" role="dialog" aria-labelledby="queryModalLabel"
            aria-hidden="true">
            <div class="modal-dialog" role="document">
              <div class="modal-content card">
                <div class="modal-header">
                  <h4 class="card-title" id="queryModalLabel">SPARQL query</h4>
                  <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                  </button>
                </div>
                <div class="modal-body">
                  <div class="typography-line col-md-12 col-sm-12">
                    {% for dict in datastory_data.dynamic_elements %}
                    {% for k,v in dict.items() %}
                    {% if 'title' in k %}
                    <h3 class="text-white">{{v[0]|upper}}{{v[1:]}}</h3>
                    {% endif %}
                    {% if 'query' in k and 'bind' not in k %}
                    <p>{{v}}</p>
                    <hr>
                    {% endif %}
                    {% endfor %}
                    {% endfor %}
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
<!-- alerts -->
{% if session['user_type'] == 'extra' and datastory_data.id %}
<div data-notify="container" class="col-10 col-xs-11 col-sm-4 alert alert-info" role="alert"
  data-notify-position="bottom-right"
  style="display: inline-block; margin: 0px auto; padding-left: 65px; position: fixed; transition: all 0.5s ease-in-out 0s; z-index: 1031; bottom: 20px; right: 20px;"
  data-closing="true"><button type="button" aria-hidden="true" class="close" data-dismiss="alert"
    style="position: absolute; right: 10px; top: 5px; z-index: 1033;">×</button><span data-notify="icon"
    class="flaticon-alarm-1"></span> <span data-notify="title">Important</span>
  <span data-notify="message">If you leave without downloading or publishing your data story, it will be
    deleted.</span><a href="#" target="_blank" data-notify="url"></a>
</div>
{% elif session['user_type'] == 'random' and datastory_data.id%}
<div data-notify="container" class="col-10 col-xs-11 col-sm-4 alert alert-info" role="alert"
  data-notify-position="bottom-right"
  style="display: inline-block; margin: 0px auto; padding-left: 65px; position: fixed; transition: all 0.5s ease-in-out 0s; z-index: 1031; bottom: 20px; right: 20px;"
  data-closing="true"><button type="button" aria-hidden="true" class="close" data-dismiss="alert"
    style="position: absolute; right: 10px; top: 5px; z-index: 1033;">×</button><span data-notify="icon"
    class="flaticon-alarm-1"></span> <span data-notify="title">Important</span>
  <span data-notify="message">If you leave without downloading your date story, it will be deleted.</span><a href="#"
    target="_blank" data-notify="url"></a>
</div>
{% endif %}

{% endblock content %}

<!-- Specific Page JS goes HERE  -->


{% block javascripts %}
<script type="text/javascript">
  var datastory_data = {{ datastory_data | tojson }};
  $('footer').detach();
</script>
{% if datastory_data.user_name %}
<script>
  let hostname = window.location.hostname;
  if (!hostname.includes('github')) {
    let beforeUnloadAlert = true;
    window.addEventListener('beforeunload', function (e) {
      if (!beforeUnloadAlert) return;

      // etc
      e.preventDefault();
      e.returnValue = '';
    });

    function myFunction() {
      beforeUnloadAlert = false;
    }
    var myObj = document.getElementsByClassName('prevent_alert')
    console.log(myObj);
    for (el of myObj) {
      el.addEventListener('click', myFunction);
    }
  }
</script>
{% endif %}


{% set with_filter = false|tojson %}
{% if "map_filter" in datastory_data.dynamic_elements|map(attribute="type")%}
{% set with_filter = true|tojson %}
{% endif %}
{% for dict in datastory_data.dynamic_elements %}
{% if dict.type == 'map' %}
<script type="text/javascript">
  var map = initMap("{{dict.position}}");
  var q = $("#{{dict.position}}__map_points_query").val();
  // TODO change waitfilters and idx
  var sidebar = initSidebar();
  createMap("{{datastory_data.sparql_endpoint}}", encodeURIComponent(q), "{{dict.position}}__map_preview_container", 0, {{ with_filter }}, datastory_data.color_code[0]);

</script>
<script type="text/javascript" id="dataMap"></script>
<script type="text/javascript">
  $("#sidebar").on('click', function () {
    if ($("#maps_datastory_final") != undefined && $("#sidebar") != undefined) {
      console.log("there we are");
      checked_filters = Array.from(document.querySelectorAll('input[class="map_chechbox"]:checked'));
      addRemoveMarkers(checked_filters);
    }
  });
</script>
{% endif %}
{% endfor %}


{% endblock javascripts %}
